user www-data;
worker_processes auto;
pid /run/nginx.pid;
include /etc/nginx/modules-enabled/*.conf;

events {
    worker_connections 768;
}

http {
    sendfile on;
    tcp_nopush on;
    types_hash_max_size 2048;
    client_max_body_size 20M;

    # Map Upgrade header to Connection header
    map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
    }

    # 1. MIME TYPES: Essential for proper loading of JS/CSS/SVGs
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # Force application/javascript for .js files just in case
    types {
        application/javascript mjs;
    }

    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript image/svg+xml;

    # Club Door - trs-webdev.hostleasing.net
    server {
        listen 80;
        listen [::]:80;
        server_name trs-webdev.hostleasing.net;

        location / {
            return 301 https://$host$request_uri;
        }
    }

    server {
        listen 443 ssl;
        listen [::]:443 ssl;
        server_name trs-webdev.hostleasing.net;

        ssl_certificate /etc/letsencrypt/live/trs-webdev.hostleasing.net/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/trs-webdev.hostleasing.net/privkey.pem;

        # SSL Settings
        ssl_session_cache shared:SSL:1m;
        ssl_session_timeout 1440m;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers "ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384";

        # Static Asset Caching - Optimize delivery
        location /_next/static/ {
            alias /opt/club_door/.next/static/;
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }

        location /uploads/ {
            alias /opt/club_door/public/uploads/;
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }

        # Proxy to Next.js App
        location / {
            proxy_pass http://127.0.0.1:7600;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        access_log /var/log/nginx/club_door.access.log;
        error_log /var/log/nginx/club_door.error.log;
    }

    # Scrabble - Port 81
    server {
        listen 81;
        listen [::]:81;

        # Point to the dist folder where the React build artifacts live
        root /opt/scrabble/saas_scrabble_clone/dist;
        index index.html index.htm;

        # FIX FOR REACT SPA: Route everything to index.html so React Router works
        location / {
            try_files $uri $uri/ /index.html;
        }

        # FIX: Explicitly handle JS files to force correct MIME type
        location ~* \.js$ {
            default_type application/javascript;
            add_header Content-Type application/javascript;
            expires 1y;
            add_header Cache-Control "public, no-transform";
        }

        # Cache other static assets
        location ~* \.(css|png|jpg|jpeg|gif|ico|svg)$ {
            expires 1y;
            add_header Cache-Control "public, no-transform";
        }

        access_log /var/log/nginx/port81.access.log;
        error_log /var/log/nginx/port81.error.log;
    }

    # Trivia Host - Port 82
    server {
        listen 82;
        listen [::]:82;

        root /opt/triviahost/trivia_host;
        index index.html index.htm;

        location / {
            # Assuming this is also an SPA? If so use /index.html, if static website use =404
            try_files $uri $uri/ /index.html;
        }

        access_log /var/log/nginx/port82.access.log;
        error_log /var/log/nginx/port82.error.log;
    }

    # Trivia - Port 83
    server {
        listen 83;
        listen [::]:83;

        root /opt/trivia/two_player_trivia_game;
        index index.html index.htm;

        location / {
            try_files $uri $uri/ /index.html;
        }

        access_log /var/log/nginx/port83.access.log;
        error_log /var/log/nginx/port83.error.log;
    }

    # Reserved - Port 84
    server {
        listen 84;
        listen [::]:84;

        root /var/www/html;
        index index.html index.htm;

        location / {
            try_files $uri $uri/ =404;
        }
    }

    # Reserved - Port 85
    server {
        listen 85;
        listen [::]:85;

        root /var/www/html;
        index index.html index.htm;

        location / {
            try_files $uri $uri/ =404;
        }
    }

    # Reserved - Port 86
    server {
        listen 86;
        listen [::]:86;

        root /var/www/html;
        index index.html index.htm;

        location / {
            try_files $uri $uri/ =404;
        }
    }

    # Reserved - Port 87
    server {
        listen 87;
        listen [::]:87;

        root /var/www/html;
        index index.html index.htm;

        location / {
            try_files $uri $uri/ =404;
        }
    }

    # Fosters Barred List - Port 88
    server {
        listen 88;
        listen [::]:88;

        server_name _;

        location /_next/static/ {
            alias /opt/fosters_barred_list/fosters_barred_list/.next/static/;
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }

        location /uploads/ {
            alias /opt/fosters_barred_list/fosters_barred_list/public/uploads/;
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }

        location / {
            proxy_pass http://127.0.0.1:3006;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
        }

        access_log /var/log/nginx/port88.access.log;
        error_log /var/log/nginx/port88.error.log;
    }

    # Bar Stock App - Port 4321
    server {
        listen 4321;
        listen [::]:4321;

        server_name _;

        # Static Asset Caching
        location /_next/static/ {
            alias /opt/bar_stock_app/.next/static/;
            expires 1y;
            access_log off;
            add_header Cache-Control "public";
        }

        location / {
            proxy_pass http://127.0.0.1:5400;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_cache_bypass $http_upgrade;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        access_log /var/log/nginx/port4321.access.log;
        error_log /var/log/nginx/port4321.error.log;
    }
}
